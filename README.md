# OpenRouter ä»£ç†ç›‘æ§ç³»ç»Ÿ

ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ OpenRouter/OpenAI API åå‘ä»£ç†æœåŠ¡ï¼Œæä¾›å®Œæ•´çš„è¯·æ±‚ç›‘æ§ã€ç”¨æˆ·ç®¡ç†å’Œæ•°æ®åˆ†æåŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ”„ åå‘ä»£ç†åŠŸèƒ½
- **é€æ˜ä»£ç†**: å®Œå…¨å…¼å®¹ OpenAI API æ ¼å¼ï¼Œæ— ç¼è½¬å‘åˆ° OpenRouter
- **æµå¼å“åº”æ”¯æŒ**: å®Œæ•´æ”¯æŒ SSE æµå¼è¾“å‡ºï¼Œå®æ—¶ä¼ è¾“æ•°æ®
- **è‡ªåŠ¨é‡è¯•**: æ™ºèƒ½é”™è¯¯å¤„ç†å’Œè¿æ¥ç®¡ç†
- **è¶…æ—¶æ§åˆ¶**: å¯é…ç½®çš„è¯·æ±‚è¶…æ—¶è®¾ç½®ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰

### ğŸ“Š å®æ—¶ç›‘æ§ç³»ç»Ÿ
- **è¯·æ±‚è®°å½•**: è¯¦ç»†è®°å½•æ‰€æœ‰APIè¯·æ±‚å’Œå“åº”
- **æ€§èƒ½åˆ†æ**: å“åº”æ—¶é—´ã€æˆåŠŸç‡ã€é”™è¯¯ç‡ç»Ÿè®¡
- **å®æ—¶æ›´æ–°**: å‰ç«¯å®æ—¶åˆ·æ–°ç›‘æ§æ•°æ®
- **æ•°æ®æŒä¹…åŒ–**: SQLiteæ•°æ®åº“å­˜å‚¨ï¼Œé‡å¯åæ•°æ®ä¸ä¸¢å¤±

### ğŸ” ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- **API Key è®¤è¯**: åŸºäºAPI Keyçš„ç”¨æˆ·èº«ä»½éªŒè¯
- **æƒé™åˆ†çº§**: ç®¡ç†å‘˜å¯æŸ¥çœ‹æ‰€æœ‰è®°å½•ï¼Œæ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®°å½•
- **Cookieä¼šè¯**: åŸºäºCookieçš„ç™»å½•çŠ¶æ€ç®¡ç†
- **é»˜è®¤Key**: æ”¯æŒä¸ºæœªæä¾›API Keyçš„è¯·æ±‚è®¾ç½®é»˜è®¤Key

### ğŸŒ Webç›‘æ§ç•Œé¢
- **ç°ä»£UIè®¾è®¡**: å“åº”å¼ç•Œé¢ï¼Œæ”¯æŒæ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡
- **è¯·æ±‚åˆ—è¡¨**: åˆ†é¡µæ˜¾ç¤ºæ‰€æœ‰APIè¯·æ±‚è®°å½•
- **è¯¦æƒ…æŸ¥çœ‹**: ç‚¹å‡»æŸ¥çœ‹å®Œæ•´çš„è¯·æ±‚/å“åº”è¯¦æƒ…
- **æœç´¢è¿‡æ»¤**: æ”¯æŒæŒ‰URLã€æ–¹æ³•ã€å†…å®¹ç­‰å¤šç»´åº¦æœç´¢
- **ç»Ÿè®¡é¢æ¿**: å®æ—¶æ˜¾ç¤ºæ€»è¯·æ±‚æ•°ã€æˆåŠŸç‡ã€å¹³å‡å“åº”æ—¶é—´

### ğŸ” é«˜çº§æœç´¢åŠŸèƒ½
- **å…¨æ–‡æœç´¢**: åœ¨è¯·æ±‚URLã€æ–¹æ³•ã€è¯·æ±‚ä½“ã€å“åº”ä½“ä¸­æœç´¢
- **ç”¨æˆ·è¿‡æ»¤**: æŒ‰API Keyè¿‡æ»¤æ˜¾ç¤ºç‰¹å®šç”¨æˆ·çš„è¯·æ±‚
- **æ—¶é—´æ’åº**: æŒ‰æ—¶é—´å€’åºæ˜¾ç¤ºæœ€æ–°è¯·æ±‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä»£ç†æœåŠ¡å™¨     â”‚   Webç›‘æ§ç•Œé¢   â”‚
â”‚   Port: 8080    â”‚   Port: 8081    â”‚
â”‚                 â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ è¯·æ±‚è½¬å‘    â”‚ â”‚ â”‚ ç”¨æˆ·è®¤è¯    â”‚ â”‚
â”‚ â”‚ æµå¼å¤„ç†    â”‚ â”‚ â”‚ æ•°æ®å±•ç¤º    â”‚ â”‚
â”‚ â”‚ é”™è¯¯å¤„ç†    â”‚ â”‚ â”‚ æœç´¢è¿‡æ»¤    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  SQLite æ•°æ®åº“  â”‚
          â”‚  è¯·æ±‚è®°å½•å­˜å‚¨   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Python 3.7+
- pip åŒ…ç®¡ç†å™¨

### å®‰è£…éƒ¨ç½²

1. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone <repository-url>
   cd openrouter-proxy
   ```

2. **å®‰è£…ä¾èµ–**
   ```bash
   pip install -r requirements.txt
   ```

3. **å¯åŠ¨æœåŠ¡**
   ```bash
   python run.py
   ```

4. **è®¿é—®æœåŠ¡**
   ```
   ğŸš€ OpenAI ä»£ç†æœåŠ¡
   ============================================================
   ğŸ“¡ ä»£ç†æœåŠ¡å™¨: http://127.0.0.1:8080
   ğŸŒ Webç•Œé¢: http://127.0.0.1:8081
   ============================================================
   ```

### Docker éƒ¨ç½²

ä½¿ç”¨ Docker Compose å¿«é€Ÿéƒ¨ç½²ï¼š

```bash
docker-compose up -d
```

è¯¦ç»†çš„ Docker éƒ¨ç½²è¯´æ˜è¯·å‚è€ƒ [DOCKER.md](DOCKER.md)

## ğŸ”§ é…ç½®è¯´æ˜

### åŸºç¡€é…ç½® (config.py)

```python
# æœåŠ¡å™¨é…ç½®
PROXY_HOST = "127.0.0.1"        # ä»£ç†æœåŠ¡å™¨ä¸»æœº
PROXY_PORT = 8080               # ä»£ç†æœåŠ¡å™¨ç«¯å£
WEB_HOST = "127.0.0.1"          # Webç•Œé¢ä¸»æœº  
WEB_PORT = 8081                 # Webç•Œé¢ç«¯å£

# APIé…ç½®
OPENAI_API_BASE = "https://openrouter.ai/api/v1"  # OpenRouter APIåœ°å€
DEFAULT_APIKEY = "sk-hntsz-free-key"              # é»˜è®¤API Key
SUPER_ADMIN_APIKEY = ""                           # è¶…ç®¡API Key

# æ•°æ®é…ç½®
MAX_REQUESTS_HISTORY = 1000     # æœ€å¤§å†å²è®°å½•æ•°
PAGE_SIZE = 20                  # åˆ†é¡µå¤§å°
```

### ç¯å¢ƒå˜é‡æ”¯æŒ

æ‰€æœ‰é…ç½®é¡¹éƒ½æ”¯æŒç¯å¢ƒå˜é‡ï¼š

```bash
export PROXY_HOST=0.0.0.0
export PROXY_PORT=8080
export WEB_PORT=8081
export SUPER_ADMIN_APIKEY=your-admin-key
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### å®¢æˆ·ç«¯é…ç½®

å°†ä½ çš„ OpenAI å®¢æˆ·ç«¯é…ç½®ä¸ºä½¿ç”¨ä»£ç†æœåŠ¡å™¨ï¼š

#### Python (openai åº“)
```python
import openai

# æ–°ç‰ˆæœ¬ (v1.0+)
client = openai.OpenAI(
    base_url="http://127.0.0.1:8080/v1",
    api_key="your-openrouter-api-key"
)

response = client.chat.completions.create(
    model="anthropic/claude-3.5-sonnet",
    messages=[{"role": "user", "content": "Hello!"}]
)

# æ—§ç‰ˆæœ¬
openai.api_base = "http://127.0.0.1:8080/v1"
openai.api_key = "your-openrouter-api-key"
```

#### curl ç¤ºä¾‹
```bash
curl http://127.0.0.1:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-openrouter-api-key" \
  -d '{
    "model": "anthropic/claude-3.5-sonnet",
    "messages": [{"role": "user", "content": "Hello!"}],
    "stream": true
  }'
```

#### JavaScript/Node.js
```javascript
import OpenAI from 'openai';

const openai = new OpenAI({
  baseURL: 'http://127.0.0.1:8080/v1',
  apiKey: 'your-openrouter-api-key',
});

const response = await openai.chat.completions.create({
  model: 'anthropic/claude-3.5-sonnet',
  messages: [{ role: 'user', content: 'Hello!' }],
});
```

### Webç•Œé¢ä½¿ç”¨

1. **ç™»å½•è®¤è¯**
   - è®¿é—® `http://127.0.0.1:8081`
   - è¾“å…¥ä½ çš„ OpenRouter API Key ç™»å½•
   - ç®¡ç†å‘˜Keyå¯æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·è¯·æ±‚

2. **ç›‘æ§é¢æ¿**
   - æŸ¥çœ‹å®æ—¶ç»Ÿè®¡ï¼šæ€»è¯·æ±‚æ•°ã€æˆåŠŸç‡ã€å¹³å‡å“åº”æ—¶é—´
   - æµè§ˆè¯·æ±‚åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µå¯¼èˆª
   - ä½¿ç”¨æœç´¢åŠŸèƒ½å¿«é€Ÿå®šä½ç‰¹å®šè¯·æ±‚

3. **è¯·æ±‚è¯¦æƒ…**
   - ç‚¹å‡»ä»»æ„è¯·æ±‚æŸ¥çœ‹å®Œæ•´è¯¦æƒ…
   - åŒ…å«è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ã€å“åº”å¤´ã€å“åº”ä½“
   - æ˜¾ç¤ºå“åº”æ—¶é—´å’ŒçŠ¶æ€ç 

## ğŸ”Œ API æ¥å£

WebæœåŠ¡å™¨æä¾› RESTful APIï¼š

### è·å–è¯·æ±‚åˆ—è¡¨
```http
GET /api/requests?page=1&search=keyword
```

**å“åº”æ ¼å¼:**
```json
{
  "requests": [...],
  "total_count": 100,
  "page": 1,
  "page_size": 20
}
```

### è·å–è¯·æ±‚è¯¦æƒ…
```http
GET /api/request/{request_id}
```

### è·å–ç»Ÿè®¡ä¿¡æ¯
```http
GET /api/stats
```

**å“åº”æ ¼å¼:**
```json
{
  "total_requests": 150,
  "success_rate": 98.5,
  "avg_response_time": 1250.3,
  "recent_requests_count": 10
}
```

## ğŸ—„ï¸ æ•°æ®å­˜å‚¨

### SQLite æ•°æ®åº“ç»“æ„

```sql
CREATE TABLE requests (
    id TEXT PRIMARY KEY,                -- è¯·æ±‚å”¯ä¸€ID
    timestamp TEXT NOT NULL,            -- è¯·æ±‚æ—¶é—´æˆ³
    method TEXT NOT NULL,               -- HTTPæ–¹æ³•
    url TEXT NOT NULL,                  -- è¯·æ±‚URL
    headers TEXT NOT NULL,              -- è¯·æ±‚å¤´(JSON)
    body TEXT,                          -- è¯·æ±‚ä½“
    authorization_bearer TEXT,          -- API Key
    response_status INTEGER,            -- å“åº”çŠ¶æ€ç 
    response_headers TEXT,              -- å“åº”å¤´(JSON)
    response_body TEXT,                 -- å“åº”ä½“
    duration_ms REAL,                   -- å“åº”æ—¶é—´(æ¯«ç§’)
    error TEXT                          -- é”™è¯¯ä¿¡æ¯
);
```

### æ•°æ®ç‰¹æ€§
- **æŒä¹…åŒ–å­˜å‚¨**: æ•°æ®ä¿å­˜åœ¨ `proxy_requests.db` æ–‡ä»¶ä¸­
- **å¹¶å‘å®‰å…¨**: ä½¿ç”¨çº¿ç¨‹é”ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **è‡ªåŠ¨ç´¢å¼•**: æŒ‰æ—¶é—´æˆ³å’ŒAPI Keyå»ºç«‹ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
- **æœç´¢ä¼˜åŒ–**: æ”¯æŒå…¨æ–‡æœç´¢å¤šä¸ªå­—æ®µ

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
# æµ‹è¯•åŸºæœ¬ä»£ç†åŠŸèƒ½
python test_proxy.py

# æµ‹è¯•æµå¼å“åº”
python test_streaming.py
```

### æµ‹è¯•æµç¨‹
1. ç¡®ä¿æœåŠ¡å·²å¯åŠ¨
2. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ä»£ç†åŠŸèƒ½
3. åœ¨Webç•Œé¢æŸ¥çœ‹æµ‹è¯•è¯·æ±‚è®°å½•
4. éªŒè¯ç»Ÿè®¡æ•°æ®æ›´æ–°

## ğŸ³ Docker æ”¯æŒ

### å¿«é€Ÿéƒ¨ç½²
```bash
# ä½¿ç”¨ docker-compose
docker-compose up -d

# ä½¿ç”¨ docker
docker build -t openrouter-proxy .
docker run -p 8080:8080 -p 8081:8081 openrouter-proxy
```

### é…ç½®æŒ‚è½½
```yaml
volumes:
  - ./data:/app/data          # æ•°æ®åº“æ–‡ä»¶æŒä¹…åŒ–
  - ./config.py:/app/config.py # è‡ªå®šä¹‰é…ç½®
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨è€ƒè™‘
- **æ•æ„Ÿæ•°æ®**: ç³»ç»Ÿä¼šè®°å½•å®Œæ•´çš„è¯·æ±‚å’Œå“åº”å†…å®¹ï¼Œè¯·åœ¨å®‰å…¨ç¯å¢ƒä¸­ä½¿ç”¨
- **API Keyä¿æŠ¤**: API Keyä¼šä»¥æ˜æ–‡å½¢å¼å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œç¡®ä¿æ•°æ®åº“æ–‡ä»¶å®‰å…¨
- **ç½‘ç»œè®¿é—®**: é»˜è®¤åªç›‘å¬æœ¬åœ°åœ°å€ï¼Œç”Ÿäº§ç¯å¢ƒè¯·é…ç½®é˜²ç«å¢™

### æ€§èƒ½å½±å“
- **å»¶è¿Ÿå¢åŠ **: ä»£ç†ä¼šå¢åŠ  2-10ms çš„å»¶è¿Ÿ
- **å†…å­˜ä½¿ç”¨**: è¯·æ±‚æ•°æ®ä¼šå ç”¨é¢å¤–å†…å­˜å’Œç£ç›˜ç©ºé—´
- **å¹¶å‘å¤„ç†**: æ”¯æŒé«˜å¹¶å‘è¯·æ±‚ï¼Œä½†å—é™äºå•æœºæ€§èƒ½

### å­˜å‚¨ç®¡ç†
- **æ•°æ®åº“å¤§å°**: é•¿æœŸä½¿ç”¨ä¼šäº§ç”Ÿå¤§é‡æ•°æ®ï¼Œå»ºè®®å®šæœŸæ¸…ç†
- **å¤‡ä»½ç­–ç•¥**: é‡è¦æ•°æ®è¯·å®šæœŸå¤‡ä»½ SQLite æ•°æ®åº“æ–‡ä»¶
- **ç£ç›˜ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿç£ç›˜ç©ºé—´å­˜å‚¨è¯·æ±‚æ—¥å¿—

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£è¢«å ç”¨**
   ```
   OSError: [Errno 48] Address already in use
   ```
   - ä¿®æ”¹ `config.py` ä¸­çš„ç«¯å£é…ç½®
   - æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡ `PROXY_PORT`ã€`WEB_PORT`

2. **ä¾èµ–å®‰è£…å¤±è´¥**
   ```bash
   pip install -r requirements.txt --upgrade
   ```
   - ç¡®ä¿ä½¿ç”¨ Python 3.7+ ç‰ˆæœ¬
   - å°è¯•ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ

3. **æ•°æ®åº“é”å®š**
   ```
   sqlite3.OperationalError: database is locked
   ```
   - ç¡®ä¿æ²¡æœ‰å¤šä¸ªè¿›ç¨‹åŒæ—¶è®¿é—®æ•°æ®åº“
   - é‡å¯æœåŠ¡è§£å†³é”å®šé—®é¢˜

4. **æ— æ³•è¿æ¥ OpenRouter**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯ API Key æ˜¯å¦æœ‰æ•ˆ
   - ç¡®è®¤ `OPENAI_API_BASE` é…ç½®æ­£ç¡®

### æ—¥å¿—è°ƒè¯•

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## ğŸ“ å¼€å‘è¯´æ˜

### é¡¹ç›®ç»“æ„
```
openrouter-proxy/
â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†
â”œâ”€â”€ models.py              # æ•°æ®æ¨¡å‹å’Œå­˜å‚¨
â”œâ”€â”€ proxy_server.py        # ä»£ç†æœåŠ¡å™¨æ ¸å¿ƒ
â”œâ”€â”€ web_server.py          # Webç•Œé¢æœåŠ¡å™¨
â”œâ”€â”€ run.py                 # å¯åŠ¨å…¥å£
â”œâ”€â”€ requirements.txt       # Pythonä¾èµ–
â”œâ”€â”€ Dockerfile             # Dockeré•œåƒ
â”œâ”€â”€ docker-compose.yml     # Dockerç¼–æ’
â”œâ”€â”€ templates/             # HTMLæ¨¡æ¿
â”‚   â”œâ”€â”€ index.html         # ä¸»é¡µé¢
â”‚   â”œâ”€â”€ login.html         # ç™»å½•é¡µé¢
â”‚   â””â”€â”€ request_detail.html # è¯·æ±‚è¯¦æƒ…é¡µé¢
â”œâ”€â”€ static/                # é™æ€èµ„æº
â”‚   â”œâ”€â”€ style.css          # æ ·å¼æ–‡ä»¶
â”‚   â””â”€â”€ script.js          # å‰ç«¯è„šæœ¬
â”œâ”€â”€ test_proxy.py          # ä»£ç†åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ test_streaming.py      # æµå¼å“åº”æµ‹è¯•
â”œâ”€â”€ DOCKER.md              # Dockeréƒ¨ç½²æ–‡æ¡£
â”œâ”€â”€ USAGE.md               # ä½¿ç”¨æŒ‡å—
â””â”€â”€ README.md              # é¡¹ç›®è¯´æ˜
```

### æŠ€æœ¯æ ˆ
- **åç«¯**: Python 3.7+, aiohttp, SQLite
- **å‰ç«¯**: HTML5, CSS3, JavaScript (Vanilla)
- **æ•°æ®åº“**: SQLite 3
- **æ¨¡æ¿å¼•æ“**: Jinja2
- **éƒ¨ç½²**: Docker, Docker Compose
